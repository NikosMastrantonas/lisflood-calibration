# The LISFLOOD calibration
The calibration of the LISFLOOD model is a complex workflow, which involves the preparation of static data, the configuration of the model and the definition of objective functions associated with an optimisation algorithm. This pages highlights some of those concepts.

## Input data
This describes all preparation necessary to acquire meteorological forcing maps and river discharge time series and associated metadata information on the calibration points. As an example, we included here how the data is computed for EFAS and GloFAS.

### Meteorological data
They are all meteorological maps (also called forcing maps) needed by LISFLOOD, including precipitation, average air temperature, potential evapo-transpiration, and evaporation rates for open water and bare soil surfaces. They should be available at the domain grid, and at the timestep of the system (for EFAS4: 6hourly) and over the full calibration period. For EFAS, the forcing maps are created by the EFAS Meteorological Data Collection Centre or the JRC by interpolating in-situ data. Note that because of low density in sub-daily measurements across Europe for variables such wind speed, solar radiation or humidity, evaporation maps (potential evapo-transpiration and evaporation rates) are derived using Penman-Monteith equation using daily data, and then disaggregated using the same evaporation rates to produce 6-hourly grids. For GloFAS, the forcing maps are based on ERA5 reanalysis interpolated by ECMWF at GloFAS resolution and produced at a 24-hourly time step. All forcing maps are created on the longest available period with consolidated meteorological and hydrological data.

### River discharge data
They are observations against which LISFLOOD simulations driven by the forcing maps will be compared to find the parameter set best representing the hydrological behaviour of a catchment.  Ideally, they should be available at the same time strep as the system, but could also be at coarser resolution. River discharge data are collected by the EFAS Hydrological Data Collection Centre and the JRC and maintained in specific geospatial databases (e.g. Floods-GeoDatabase for EFAS). They also include metadata such as river and gauge name, location and upstream drained area. Before a calibration exercise and after acquisition, each dataset is explored by ECMWF to identify available record length, duplicated entries, low quality data (e.g. missing/ invalid data, outliers, location error) or influenced regime (e.g. from reservoirs or lakes) using automatic procedures and statistical analysis (e.g. flow duration curves, annual hydrograph, annual totals) and visual time series inspections. In addition to quality acceptable quality and reduced influence from reservoirs and lakes, calibration stations are selected according to drained area (> 500 km2 for EFAS 5km grid and > 5000 km2 for GloFAS 0.1 deg grid), record length (>= 4 years), time step (generally daily but if available sub-daily for EFAS), spatial coverage (as large as possible, including some tolerance on data quality and availability but excluding close stations on the same river branch - for EFAS 5km grid those with drained area different less 200 km2, prioritising first sub-daily data and then longest available record). Consistency between discharge values at adjacent stations on the same river are also checked, as large differences could be a sign of issues with rating curves, the presence of hydraulic structures (i.e. a dam) and extensive floodplains, or potentially even errors with the station locations, and hence low quality.

## Calibration parameters, objective function and optimization algorithm
We describe here the principle of calibration applied through the specific examples of GloFAS and EFAS4 calibration.

### Calibration parameters
Depending on the calibration aim and spatial domain to be applied to, different calibration strategies have been applied in the past, ranging from 8 parameters (most GloFAS configurations) to 14 parameters (EFAS4).
Earlier work identified the most sensitive parameters, hence requiring calibration, being those controlling snow accumulation and melting, overland flow, percolation to the lower groundwater zone, residence time of the upper and lower groundwater zone, lakes, reservoirs and channel routing (e.g. Feyen et al., 2007, https://doi.org/10.1016/j.jhydrol.2006.07.004; Zajac et al., 2013,http://publications.jrc.ec.europa.eu/repository/handle/JRC32044; Revilla-Romero et al., 2015,https://doi.org/10.1016/j.rse.2015.10.022; Beck et al., 2017, https://doi.org/10.5194/hess-21-2881-2017; Zajac et al.,2017, https://doi.org/10.1016/j.jhydrol.2017.03.022; Hirpa et al., 2018, https://doi.org/10.1016/j.jhydrol.2018.09.052; Arnal at al. 2019, http://publications.jrc.ec.europa.eu/repository/handle/JRC111610; Alfieri et al., 2020, https://doi.org/10.1016/j.hydroa.2019.100049). 
For each of the calibration parameters, a parameters space needs to be defined with physically realistic lower/upper limits for physically based parameters and largest admissible ranges for empirical parameters. As suggested in previous work, default parameters are currently used for catchments not included in the calibration, but alternative strategies will be also explored.

## Objective function
The objective function is the statistical measures used to optimise the model parameters. The modified Kling-Gupta efficiency (KGE’; Gupta et al., 2009, https://doi.org/10.1016/j.jhydrol.2009.08.003; Kling et al., 2012, https://doi.org/10.1016/j.jhydrol.2012.01.011) has been chosen to calibrate LISFLOOD, as it provides a way to achieve balanced improvement of simulated mean flow, flow variability, and correlation. All three components of KGE’ represent desirable characteristics of the hydrological regime in the context of EFAS and GloFAS: correlation evaluates the flow timing, of paramount importance for EFAS and GloFAS to issue timely warnings; variability bias measures the statistical variability, ensuring that frequency and magnitude of peaks are correctly reproduced by the system; and mean bias describes the long-term water balance, important for any hydrological application. It is envisaged that the definition of the objective function will be further explored including for example non-uniform weight for each KGE' components, alternative correlation algorithms in the KGE, e.g. Pearson's rank correlation instead of Fisher's correlation coefficients, or multi-objective function based on any combination of KGE', KGE' components, additional error metrics such as total error or MAE, or time series and distribution statistics.

### Optimization algorithm
The optimisation algorithm is the mechanism to search the parameter space in a way the most computationally- efficient possible. The Distributed Evolutionary Algorithms in Python (DEAP) toolkit (Fortin et al., 2012, https://jmlr.org/papers/volume13/fortin12a/fortin12a.pdf; De Rainville et al., 2012, https://doi.org/10.1145/2330784.2330799; De Rainville et al., 2014, https://doi.org/10.1145/2597453.2597455; DEAP repository, https://github.com/deap/deap) has been used to calibrate LISFLOOD using a script developed at the JRC (Hirpa et al., 2018, https://doi.org/10.1016/j.jhydrol.2018.09.052) and available in the OpenSource LISFLOOD platform (https://ec-jrc.github.io/lisflood/). As an Evolutionary Algorithm, DEAP is a population-based optimisation algorithm in which each individual (e.g, a vector of model parameters) in a large population represents a candidate solution for the optimisation problem. The goodness of fit for each individual is evaluated based on selected objective functions, which are designed as either maximisation (e.g, Kling-Gupta efficiency) or minimisation (e.g., root mean square error) equations constrained by physically meaningful model parameter ranges. The basic principle of the EA is to modify and improve the population through evolution over a range of generations, from one generation (parent) to the next (offspring), and ultimately identify the best performing individual. Changes were implemented during EFAS 4.0 calibration to ensure a hydrologically-aware selection of the best calibration solution from the pareto front by enhancing elitism based on KGE', correlation and total absolute error.
